<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D√©barrasse-moi - Signalement d'encombrants √† Paris</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f4f8;
            display: flex;
            flex-direction: column;
        }

        /* === HEADER === */
        .header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
            z-index: 1000;
        }

        .logo {
            width: 45px;
            height: 45px;
            flex-shrink: 0;
        }

        .header-text h1 {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .header-text p {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* === MAIN LAYOUT === */
        .main-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* === SIDEBAR === */
        .sidebar {
            width: 360px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 100;
            -webkit-overflow-scrolling: touch;
        }

        .sidebar h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #48bb78;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 70px;
        }

        .form-group select {
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 12px center;
        }

        .btn-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .btn-submit:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .stats {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .stats-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.85rem;
        }

        .stats-count {
            font-size: 1.8rem;
            font-weight: 700;
            color: #48bb78;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            margin-top: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
        }

        .status-dot.offline {
            background: #f56565;
        }

        .info-box {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 12px;
            border-radius: 0 8px 8px 0;
            margin-top: 15px;
        }

        .info-box p {
            color: #2b6cb0;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* === MAP CONTAINER - CL√â DU FIX === */
        .map-wrapper {
            flex: 1;
            position: relative;
            min-width: 0;
            min-height: 0;
        }

        #map {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1;
        }

        /* Fix Leaflet sur iOS */
        .leaflet-container {
            width: 100% !important;
            height: 100% !important;
        }

        .leaflet-tile-pane {
            -webkit-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
        }

        /* === POPUP === */
        .popup-content h3 {
            color: #2d3748;
            font-size: 0.95rem;
            margin-bottom: 6px;
        }

        .popup-content p {
            color: #718096;
            font-size: 0.8rem;
            margin: 4px 0;
        }

        .popup-content .date {
            color: #48bb78;
            font-weight: 600;
        }

        .btn-reserve {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* === TOAST === */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #48bb78;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 9999;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error { background: #f56565; }
        .toast.info { background: #4299e1; }

        /* === RESPONSIVE === */
        @media (max-width: 900px) {
            .main-wrapper {
                flex-direction: column-reverse;
            }

            .sidebar {
                width: 100%;
                max-height: 45%;
                border-top: 1px solid #e2e8f0;
            }

            .map-wrapper {
                flex: 1;
                min-height: 55%;
            }
        }

        @media (max-width: 500px) {
            .header {
                padding: 10px 15px;
            }

            .header-text h1 {
                font-size: 1.2rem;
            }

            .sidebar {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="bagGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#48bb78" />
                    <stop offset="100%" style="stop-color:#38a169" />
                </linearGradient>
            </defs>
            <path d="M25 30 L20 85 Q20 95 30 95 L70 95 Q80 95 80 85 L75 30 Z" fill="url(#bagGradient)"/>
            <ellipse cx="50" cy="28" rx="20" ry="8" fill="#38a169"/>
            <path d="M40 20 Q50 10 60 20" stroke="#38a169" stroke-width="6" fill="none" stroke-linecap="round"/>
            <circle cx="38" cy="55" r="4" fill="#1a202c"/>
            <circle cx="62" cy="55" r="4" fill="#1a202c"/>
            <path d="M35 70 Q50 82 65 70" stroke="#1a202c" stroke-width="4" fill="none" stroke-linecap="round"/>
        </svg>
        <div class="header-text">
            <h1>D√©barrasse-moi</h1>
            <p>Signalement d'encombrants √† Paris</p>
        </div>
    </header>

    <div class="main-wrapper">
        <aside class="sidebar">
            <h2>üìç Nouveau signalement</h2>
            
            <form id="signalementForm">
                <div class="form-group">
                    <label for="adresse">Adresse</label>
                    <input type="text" id="adresse" placeholder="Ex: 15 rue de la Paix" required>
                </div>

                <div class="form-group">
                    <label for="arrondissement">Arrondissement</label>
                    <select id="arrondissement" required>
                        <option value="">S√©lectionner...</option>
                        <option value="75001">1er</option>
                        <option value="75002">2√®me</option>
                        <option value="75003">3√®me</option>
                        <option value="75004">4√®me</option>
                        <option value="75005">5√®me</option>
                        <option value="75006">6√®me</option>
                        <option value="75007">7√®me</option>
                        <option value="75008">8√®me</option>
                        <option value="75009">9√®me</option>
                        <option value="75010">10√®me</option>
                        <option value="75011">11√®me</option>
                        <option value="75012">12√®me</option>
                        <option value="75013">13√®me</option>
                        <option value="75014">14√®me</option>
                        <option value="75015">15√®me</option>
                        <option value="75016">16√®me</option>
                        <option value="75017">17√®me</option>
                        <option value="75018">18√®me</option>
                        <option value="75019">19√®me</option>
                        <option value="75020">20√®me</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="description">Description (optionnel)</label>
                    <textarea id="description" placeholder="Ex: Canap√©, machine √† laver..."></textarea>
                </div>

                <div class="form-group">
                    <label for="date">Date du d√©p√¥t</label>
                    <input type="date" id="date" required>
                </div>

                <button type="submit" class="btn-submit" id="btnSubmit">üóëÔ∏è Signaler l'encombrant</button>
            </form>

            <div class="stats">
                <div class="stats-title">Signalements disponibles</div>
                <div class="stats-count" id="statsCount">-</div>
                <div class="connection-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Connexion...</span>
                </div>
            </div>

            <div class="info-box">
                <p>üí° <strong>Astuce :</strong> Touchez la carte pour placer un marqueur.</p>
            </div>
        </aside>

        <div class="map-wrapper">
            <div id="map"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./env.js"></script>
    <script>
    (function() {
        'use strict';

        // === CONFIGURATION ===
        var ENV = window.ENV || {};
        var SUPABASE_URL = ENV.SUPABASE_URL;
        var SUPABASE_ANON_KEY = ENV.SUPABASE_ANON_KEY;
        var supabaseClient = null;

        if (SUPABASE_URL && SUPABASE_ANON_KEY) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // === VARIABLES ===
        var map = null;
        var markers = [];
        var markersById = {};
        var tempMarker = null;
        var selectedCoords = null;

        // === IC√îNES ===
        var trashIcon = L.divIcon({
            html: '<div style="background:linear-gradient(135deg,#48bb78,#38a169);width:30px;height:30px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid white;"><span style="transform:rotate(45deg);font-size:12px;">üóëÔ∏è</span></div>',
            className: '',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -30]
        });

        var tempIcon = L.divIcon({
            html: '<div style="background:#4299e1;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid white;"><span style="font-size:10px;">üìç</span></div>',
            className: '',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        // === INIT MAP ===
        function initMap() {
            var mapEl = document.getElementById('map');
            if (!mapEl) {
                console.error('Element #map non trouv√©');
                return;
            }

            // Cr√©er la carte
            map = L.map(mapEl, {
                center: [48.8566, 2.3522],
                zoom: 12,
                zoomControl: true,
                tap: true,
                dragging: true,
                touchZoom: true
            });

            // Ajouter les tuiles
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);

            // √âv√©nement clic
            map.on('click', onMapClick);

            // Force le redimensionnement apr√®s chargement complet
            function forceResize() {
                if (map) {
                    map.invalidateSize(true);
                }
            }

            // Plusieurs tentatives de redimensionnement
            setTimeout(forceResize, 100);
            setTimeout(forceResize, 300);
            setTimeout(forceResize, 500);
            setTimeout(forceResize, 1000);
            setTimeout(forceResize, 2000);

            // √âcouter le resize
            window.addEventListener('resize', function() {
                setTimeout(forceResize, 100);
            });

            // √âcouter l'orientation
            window.addEventListener('orientationchange', function() {
                setTimeout(forceResize, 300);
            });
        }

        // === MAP CLICK ===
        function onMapClick(e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;
            selectedCoords = { lat: lat, lng: lng };

            if (tempMarker) {
                map.removeLayer(tempMarker);
            }
            tempMarker = L.marker([lat, lng], { icon: tempIcon }).addTo(map);

            // G√©ocodage inverse
            fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng + '&addressdetails=1')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data && data.address) {
                        var addr = data.address;
                        var street = ((addr.house_number || '') + ' ' + (addr.road || addr.pedestrian || '')).trim();
                        document.getElementById('adresse').value = street || (data.display_name || '').split(',')[0];

                        if (addr.postcode && addr.postcode.indexOf('750') === 0) {
                            document.getElementById('arrondissement').value = addr.postcode;
                        }
                    }
                })
                .catch(function() {});

            showToast('üìç Position s√©lectionn√©e !');
        }

        // === INIT FORM ===
        function initForm() {
            var dateInput = document.getElementById('date');
            var today = new Date().toISOString().split('T')[0];
            dateInput.value = today;

            document.getElementById('signalementForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addSignalement();
            });
        }

        // === LOAD SIGNALEMENTS ===
        function loadSignalements() {
            if (!supabaseClient) {
                updateConnectionStatus(false);
                return;
            }

            supabaseClient
                .from('signalements')
                .select('*')
                .eq('reserved', false)
                .order('created_at', { ascending: false })
                .then(function(result) {
                    if (result.error) {
                        throw result.error;
                    }

                    updateConnectionStatus(true);

                    // Nettoyer les anciens marqueurs
                    markers.forEach(function(m) {
                        map.removeLayer(m);
                    });
                    markers = [];
                    markersById = {};

                    // Ajouter les nouveaux
                    var data = result.data || [];
                    data.forEach(function(sig) {
                        addMarkerToMap(sig);
                    });

                    document.getElementById('statsCount').textContent = data.length;
                })
                .catch(function() {
                    updateConnectionStatus(false);
                    showToast('‚ùå Erreur de connexion', 'error');
                });
        }

        // === ADD SIGNALEMENT ===
        function addSignalement() {
            if (!supabaseClient) {
                showToast('‚ùå Base de donn√©es non connect√©e', 'error');
                return;
            }

            var btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.textContent = '‚è≥ Envoi...';

            var adresse = document.getElementById('adresse').value.trim();
            var arrondissement = document.getElementById('arrondissement').value;
            var description = document.getElementById('description').value.trim();
            var date = document.getElementById('date').value;

            var lat, lng;
            if (selectedCoords) {
                lat = selectedCoords.lat;
                lng = selectedCoords.lng;
            } else {
                var coords = getArrondissementCoords(arrondissement);
                lat = coords.lat + (Math.random() - 0.5) * 0.01;
                lng = coords.lng + (Math.random() - 0.5) * 0.01;
            }

            supabaseClient
                .from('signalements')
                .insert([{
                    adresse: adresse,
                    arrondissement: arrondissement,
                    description: description,
                    date: date,
                    lat: lat,
                    lng: lng,
                    reserved: false
                }])
                .select()
                .single()
                .then(function(result) {
                    if (result.error) throw result.error;

                    addMarkerToMap(result.data);

                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }
                    selectedCoords = null;

                    var count = parseInt(document.getElementById('statsCount').textContent) || 0;
                    document.getElementById('statsCount').textContent = count + 1;

                    document.getElementById('signalementForm').reset();
                    document.getElementById('date').value = new Date().toISOString().split('T')[0];

                    map.setView([lat, lng], 15);
                    showToast('‚úÖ Signalement enregistr√© !');

                    btn.disabled = false;
                    btn.textContent = 'üóëÔ∏è Signaler l\'encombrant';
                })
                .catch(function() {
                    showToast('‚ùå Erreur lors de l\'enregistrement', 'error');
                    btn.disabled = false;
                    btn.textContent = 'üóëÔ∏è Signaler l\'encombrant';
                });
        }

        // === RESERVE ===
        window.reserveSignalement = function(id) {
            if (!confirm('Voulez-vous r√©server cet encombrant ?')) return;
            if (!supabaseClient) return;

            supabaseClient
                .from('signalements')
                .update({ reserved: true })
                .eq('id', id)
                .then(function(result) {
                    if (result.error) throw result.error;

                    if (markersById[id]) {
                        map.removeLayer(markersById[id]);
                        var idx = markers.indexOf(markersById[id]);
                        if (idx > -1) markers.splice(idx, 1);
                        delete markersById[id];
                    }

                    var count = parseInt(document.getElementById('statsCount').textContent) || 0;
                    document.getElementById('statsCount').textContent = Math.max(0, count - 1);

                    showToast('‚úÖ R√©serv√© !', 'info');
                })
                .catch(function() {
                    showToast('‚ùå Erreur', 'error');
                });
        };

        // === ADD MARKER ===
        function addMarkerToMap(sig) {
            var descHtml = sig.description ? '<p><strong>Description :</strong> ' + sig.description + '</p>' : '';
            var popup = '<div class="popup-content">' +
                '<h3>üìç ' + sig.adresse + '</h3>' +
                '<p><strong>Arrondissement :</strong> ' + formatArrondissement(sig.arrondissement) + '</p>' +
                descHtml +
                '<p class="date">üìÖ ' + formatDate(sig.date) + '</p>' +
                '<button class="btn-reserve" onclick="reserveSignalement(\'' + sig.id + '\')">‚úÖ R√©server</button>' +
                '</div>';

            var marker = L.marker([sig.lat, sig.lng], { icon: trashIcon })
                .addTo(map)
                .bindPopup(popup);

            markers.push(marker);
            markersById[sig.id] = marker;
        }

        // === HELPERS ===
        function getArrondissementCoords(code) {
            var coords = {
                '75001': { lat: 48.8607, lng: 2.3426 },
                '75002': { lat: 48.8675, lng: 2.3411 },
                '75003': { lat: 48.8637, lng: 2.3592 },
                '75004': { lat: 48.8545, lng: 2.3575 },
                '75005': { lat: 48.8448, lng: 2.3501 },
                '75006': { lat: 48.8495, lng: 2.3326 },
                '75007': { lat: 48.8566, lng: 2.3150 },
                '75008': { lat: 48.8763, lng: 2.3106 },
                '75009': { lat: 48.8769, lng: 2.3379 },
                '75010': { lat: 48.8762, lng: 2.3599 },
                '75011': { lat: 48.8598, lng: 2.3793 },
                '75012': { lat: 48.8413, lng: 2.3876 },
                '75013': { lat: 48.8320, lng: 2.3561 },
                '75014': { lat: 48.8286, lng: 2.3268 },
                '75015': { lat: 48.8412, lng: 2.2925 },
                '75016': { lat: 48.8637, lng: 2.2769 },
                '75017': { lat: 48.8867, lng: 2.3131 },
                '75018': { lat: 48.8925, lng: 2.3444 },
                '75019': { lat: 48.8871, lng: 2.3822 },
                '75020': { lat: 48.8638, lng: 2.3984 }
            };
            return coords[code] || { lat: 48.8566, lng: 2.3522 };
        }

        function formatArrondissement(code) {
            var num = parseInt(code.slice(-2));
            return num === 1 ? '1er' : num + '√®me';
        }

        function formatDate(dateStr) {
            var d = new Date(dateStr);
            var months = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
            return d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
        }

        function updateConnectionStatus(connected) {
            var dot = document.getElementById('statusDot');
            var text = document.getElementById('statusText');
            if (connected) {
                dot.className = 'status-dot';
                text.textContent = 'Connect√©';
            } else {
                dot.className = 'status-dot offline';
                text.textContent = 'Hors ligne';
            }
        }

        function showToast(message, type) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (type ? ' ' + type : '');
            setTimeout(function() {
                toast.className = 'toast';
            }, 3000);
        }

        // === D√âMARRAGE ===
        function start() {
            initMap();
            initForm();
            loadSignalements();
        }

        // Attendre que tout soit charg√©
        if (document.readyState === 'complete') {
            start();
        } else {
            window.addEventListener('load', start);
        }

    })();
    </script>
</body>
</html>
