
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D√©barrasse-moi</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="env.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:#f5f5f5; }

    header{
      position:fixed; top:0; left:0; right:0; z-index:1000;
      background:#2d3436; color:#fff;
      display:flex; align-items:center; justify-content:center; gap:12px;
      padding:12px 14px;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{ width:40px; height:40px; flex:0 0 40px; }
    .title{ display:flex; flex-direction:column; line-height:1.1; }
    .title h1{ font-size:1.2rem; }
    .title p{ font-size:.82rem; opacity:.8; margin-top:2px; }

    #map{ position:fixed; top:72px; left:0; right:0; bottom:78px; }

    .stats{
      position:fixed; top:82px; right:10px; z-index:900;
      background:#fff; padding:8px 10px; border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,.12);
      font-size:.85rem;
    }

    .btn-add{
      position:fixed; bottom:0; left:0; right:0; z-index:1000;
      background:#e17055; color:#fff; border:none;
      padding:18px; font-size:1.05rem; font-weight:800;
      cursor:pointer;
    }
    .btn-add:active{ transform: translateY(1px); }

    .modal-overlay{
      display:none; position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.5);
      align-items:flex-end; justify-content:center;
    }
    .modal-overlay.active{ display:flex; }

    .modal{
      background:#fff; width:100%; max-width:520px;
      border-radius:16px 16px 0 0;
      padding:18px; max-height:85vh; overflow:auto;
    }

    .modal h2{ margin-bottom:12px; color:#2d3436; }
    .form-group{ margin-bottom:12px; }
    label{ display:block; font-weight:700; font-size:.9rem; margin-bottom:6px; color:#636e72; }
    input, select, textarea{
      width:100%; padding:10px; border-radius:10px;
      border:2px solid #dfe6e9; font-size:1rem; background:#fff;
    }
    textarea{ min-height:85px; resize:vertical; }

    .btn-row{ display:flex; gap:10px; margin-top:10px; }
    .btn{
      flex:1; border:none; border-radius:10px; padding:12px;
      font-weight:800; cursor:pointer;
    }
    .btn.secondary{ background:#dfe6e9; color:#2d3436; }
    .btn.primary{ background:#e17055; color:#fff; }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:92px; z-index:2500;
      background:rgba(45,52,54,.95); color:#fff;
      padding:10px 12px; border-radius:12px;
      display:none; max-width:92vw; text-align:center;
      font-size:.9rem;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <!-- Logo sac poubelle souriant -->
      <svg class="logo" viewBox="0 0 64 64" aria-label="Logo">
        <path d="M26 10c2 4 10 4 12 0l2 6c6 2 10 7 10 13 0 4-2 8-4 12-2 4-4 8-4 14 0 5-4 9-10 9H32c-6 0-10-4-10-9 0-6-2-10-4-14-2-4-4-8-4-12 0-6 4-11 10-13l2-6z"
              fill="#2ecc71" stroke="#1e7e47" stroke-width="2"/>
        <circle cx="26" cy="34" r="2.7" fill="#0b2f1c"/>
        <circle cx="38" cy="34" r="2.7" fill="#0b2f1c"/>
        <path d="M25 41c2.5 3 11.5 3 14 0" fill="none" stroke="#0b2f1c" stroke-width="2.6" stroke-linecap="round"/>
      </svg>

      <div class="title">
        <h1>D√©barrasse-moi</h1>
        <p>Les encombrants √† Paris, en un clic</p>
      </div>
    </div>
  </header>

  <div id="map"></div>
  <div class="stats" id="stats">Chargement‚Ä¶</div>
  <div class="toast" id="toast"></div>

  <button class="btn-add" onclick="openModal()">+ Signaler un encombrant</button>

  <div class="modal-overlay" id="overlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h2>üìç Nouveau signalement</h2>

      <div class="form-group">
        <label for="adresse">Adresse / lieu</label>
        <input id="adresse" placeholder="Ex : 15 rue de Rivoli, Paris 4e" />
      </div>

      <div class="form-group">
        <label for="arr">Arrondissement</label>
        <select id="arr">
          <option value="">S√©lectionner‚Ä¶</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
          <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
          <option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option>
          <option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option>
        </select>
      </div>

      <div class="form-group">
        <label for="desc">Description</label>
        <textarea id="desc" placeholder="Ex : Canap√©, bon √©tat"></textarea>
      </div>

      <div class="form-group">
        <label for="date">Disponible √† partir du</label>
        <input id="date" type="date" />
      </div>

      <div class="btn-row">
        <button class="btn secondary" onclick="closeModal()">Annuler</button>
        <button class="btn primary" onclick="publish()">Publier</button>
      </div>
    </div>
  </div>

<script>
  // 1) REMPLACE ICI
  const SUPABASE_URL = window.ENV.SUPABASE_URL;
const SUPABASE_ANON_KEY = window.ENV.SUPABASE_ANON_KEY;

const sb = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);
  // supabase-js v2 via CDN expose "supabase" global
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Centers approximatifs (Paris)
  const centers = {
    "1":[48.8606,2.3376],"2":[48.8679,2.3415],"3":[48.8637,2.3615],"4":[48.8544,2.3574],
    "5":[48.8462,2.3494],"6":[48.8499,2.3323],"7":[48.8566,2.3158],"8":[48.8744,2.3106],
    "9":[48.8769,2.3370],"10":[48.8758,2.3599],"11":[48.8592,2.3785],"12":[48.8406,2.3876],
    "13":[48.8322,2.3561],"14":[48.8331,2.3264],"15":[48.8421,2.2994],"16":[48.8637,2.2769],
    "17":[48.8879,2.3074],"18":[48.8925,2.3444],"19":[48.8817,2.3826],"20":[48.8638,2.3985]
  };

  // Map
  const map = L.map('map').setView([48.8566,2.3522],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap' }).addTo(map);

  const icon = L.divIcon({ html:'üì¶', className:'', iconSize:[30,30], iconAnchor:[15,15] });
  let markersLayer = L.layerGroup().addTo(map);

  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2200);
  }

  function openModal(){
    document.getElementById('overlay').classList.add('active');
    // set date default today
    const d = document.getElementById('date');
    if(!d.value) d.value = new Date().toISOString().slice(0,10);
  }
  function closeModal(e){
    if(!e || e.target.id === 'overlay'){
      document.getElementById('overlay').classList.remove('active');
    }
  }

  function validateForm(){
    const adresse = document.getElementById('adresse').value.trim();
    const arr = document.getElementById('arr').value.trim();
    const desc = document.getElementById('desc').value.trim();
    const date = document.getElementById('date').value.trim();
    if(!adresse || !arr || !desc || !date) return null;
    return { adresse, arrondissement: arr, description: desc, date };
  }

  async function refresh(){
    document.getElementById('stats').textContent = "Chargement‚Ä¶";
    markersLayer.clearLayers();

    const { data, error } = await sb
      .from('signalements')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(500);

    if(error){
      document.getElementById('stats').textContent = "Erreur (voir console)";
      console.error(error);
      toast("Erreur Supabase");
      return;
    }

    data.forEach(s => {
      const m = L.marker([s.lat, s.lng], { icon }).addTo(markersLayer);
      const d = s.date ? new Date(s.date).toLocaleDateString('fr-FR') : '';
      m.bindPopup(`
        <div style="min-width:200px">
          <b>${escapeHtml(s.description)}</b><br/>
          üìç ${escapeHtml(s.adresse)}<br/>
          üèõÔ∏è ${escapeHtml(String(s.arrondissement))}e<br/>
          üìÖ ${d}
        </div>
      `);
    });

    document.getElementById('stats').textContent = `${data.length} signalement(s)`;
  }

  function jitter(arr){
    const base = centers[arr] || [48.8566, 2.3522];
    return {
      lat: base[0] + (Math.random()-0.5)*0.01,
      lng: base[1] + (Math.random()-0.5)*0.01
    };
  }

  async function publish(){
    const v = validateForm();
    if(!v){
      toast("Remplis tout üôè");
      return;
    }

    const { lat, lng } = jitter(v.arrondissement);

    const { error } = await sb.from('signalements').insert({
      adresse: v.adresse,
      arrondissement: v.arrondissement,
      description: v.description,
      date: v.date, // IMPORTANT: format YYYY-MM-DD
      lat,
      lng
    });

    if(error){
      console.error(error);
      toast("Erreur √† la publication");
      return;
    }

    toast("‚úÖ Publi√© !");
    closeModal();
    // reset fields (optionnel)
    document.getElementById('adresse').value = "";
    document.getElementById('arr').value = "";
    document.getElementById('desc').value = "";
    // refresh map
    await refresh();
  }

  // petite s√©curit√© anti XSS dans les popups
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Init
  refresh();

  // (Optionnel) refresh auto toutes les 20 secondes
  setInterval(refresh, 20000);
</script>

</body>
</html>
